const MAP = `{\"name\":\"Spacebounce Official Map",\"canBeStored\": false,\"width\":900,\"height\":550,\"bg\":{\"type\":\"hockey\",\"width\":550,\"height\":240},\"vertexes\":[{\"x\":-550,\"y\":240,\"cMask\":[\"ball\"]},{\"x\":-550,\"y\":80,\"cMask\":[\"ball\"]},{\"x\":-550,\"y\":-80,\"cMask\":[\"ball\"]},{\"x\":-550,\"y\":-240,\"cMask\":[\"ball\"]},{\"x\":550,\"y\":240,\"cMask\":[\"ball\"]},{\"x\":550,\"y\":80,\"cMask\":[\"ball\"]},{\"x\":550,\"y\":-80,\"cMask\":[\"ball\"]},{\"x\":550,\"y\":-240,\"cMask\":[\"ball\"]},{\"x\":-1,\"y\":550,\"bCoef\":0.1,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"]},{\"x\":-1,\"y\":80,\"bCoef\":0.1,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"]},{\"x\":-1,\"y\":-80,\"bCoef\":0.1,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"]},{\"x\":-1,\"y\":-550,\"bCoef\":0.1,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"]},{\"x\":-1,\"y\":240,\"cMask\":[]},{\"x\":-1,\"y\":-240,\"cMask\":[]},{\"x\":-1,\"y\":80,\"bCoef\":0.1,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"]},{\"x\":-1,\"y\":-80,\"bCoef\":0.1,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"]},{\"x\":-547,\"y\":-80,\"cMask\":[]},{\"x\":-547,\"y\":-238,\"cMask\":[]},{\"x\":1.5,\"y\":-238,\"cMask\":[]},{\"x\":547,\"y\":-238,\"cMask\":[]},{\"x\":547,\"y\":-80,\"cMask\":[]},{\"x\":547,\"y\":80,\"cMask\":[]},{\"x\":547,\"y\":238,\"cMask\":[]},{\"x\":1.5,\"y\":238,\"cMask\":[]},{\"x\":-547,\"y\":238,\"cMask\":[]},{\"x\":-547,\"y\":80,\"cMask\":[]},{\"x\":1.5,\"y\":-78,\"cMask\":[]},{\"x\":1.5,\"y\":82,\"cMask\":[]}],\"segments\":[{\"v0\":16,\"v1\":17,\"cMask\":[],\"color\":\"555555\"},{\"v0\":17,\"v1\":18,\"cMask\":[],\"color\":\"555555\"},{\"v0\":18,\"v1\":19,\"cMask\":[],\"color\":\"555555\"},{\"v0\":19,\"v1\":20,\"cMask\":[],\"color\":\"555555\"},{\"v0\":20,\"v1\":21,\"vis\":false,\"cMask\":[],\"color\":\"555555\"},{\"v0\":21,\"v1\":22,\"cMask\":[],\"color\":\"555555\"},{\"v0\":22,\"v1\":23,\"cMask\":[],\"color\":\"555555\"},{\"v0\":23,\"v1\":24,\"cMask\":[],\"color\":\"555555\"},{\"v0\":24,\"v1\":25,\"cMask\":[],\"color\":\"555555\"},{\"v0\":25,\"v1\":16,\"vis\":false,\"cMask\":[],\"color\":\"555555\"},{\"v0\":18,\"v1\":26,\"cMask\":[],\"color\":\"555555\"},{\"v0\":26,\"v1\":27,\"curve\":179,\"curveF\":0.008726867790758751,\"cMask\":[],\"color\":\"555555\"},{\"v0\":27,\"v1\":26,\"curve\":-179,\"curveF\":-0.00872686779075885,\"cMask\":[],\"color\":\"555555\"},{\"v0\":27,\"v1\":23,\"cMask\":[],\"color\":\"555555\"},{\"v0\":26,\"v1\":27,\"cMask\":[],\"color\":\"6C6C6C\"},{\"v0\":15,\"v1\":14,\"cMask\":[],\"color\":\"6C6C6C\"},{\"v0\":13,\"v1\":15,\"cMask\":[],\"color\":\"DCDCFF\"},{\"v0\":14,\"v1\":12,\"cMask\":[],\"color\":\"DCDCFF\"},{\"v0\":1,\"v1\":2,\"cMask\":[],\"color\":\"D0D0E8\"},{\"v0\":5,\"v1\":6,\"cMask\":[],\"color\":\"D0D0E8\"},{\"v0\":8,\"v1\":9,\"bCoef\":0.1,\"vis\":false,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"],\"color\":\"E0E0F8\"},{\"v0\":9,\"v1\":10,\"bCoef\":0.1,\"curve\":180,\"curveF\":6.123233995736766e-17,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"blueKO\"],\"color\":\"D0D0E8\"},{\"v0\":10,\"v1\":9,\"bCoef\":0.1,\"curve\":180,\"curveF\":6.123233995736766e-17,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\"],\"color\":\"D0D0E8\"},{\"v0\":14,\"v1\":15,\"bCoef\":0.1,\"curve\":180,\"curveF\":6.123233995736766e-17,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"blueKO\"],\"color\":\"D0D0E8\"},{\"v0\":10,\"v1\":11,\"bCoef\":0.1,\"vis\":false,\"cMask\":[\"red\",\"blue\"],\"cGroup\":[\"redKO\",\"blueKO\"],\"color\":\"E0E0F8\"},{\"v0\":0,\"v1\":1,\"bias\":-100,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"},{\"v0\":2,\"v1\":3,\"bias\":-100,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"},{\"v0\":4,\"v1\":5,\"bias\":100,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"},{\"v0\":6,\"v1\":7,\"bias\":100,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"},{\"v0\":0,\"v1\":4,\"bias\":100,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"},{\"v0\":3,\"v1\":7,\"bias\":-100,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"},{\"v0\":1,\"v1\":2,\"bias\":-100,\"bCoef\":0,\"curve\":180,\"curveF\":6.123233995736766e-17,\"vis\":false,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"},{\"v0\":6,\"v1\":5,\"bias\":-100,\"bCoef\":0,\"curve\":180,\"curveF\":6.123233995736766e-17,\"vis\":false,\"cMask\":[\"ball\"],\"color\":\"D0D0E8\"}],\"planes\":[{\"normal\":[0,1],\"dist\":-550,\"bCoef\":0.1},{\"normal\":[0,-1],\"dist\":-550,\"bCoef\":0.1},{\"normal\":[1,0],\"dist\":-900,\"bCoef\":0.1},{\"normal\":[-1,0],\"dist\":-900,\"bCoef\":0.1},{\"normal\":[0,1],\"dist\":-247,\"cMask\":[\"ball\"]},{\"normal\":[0,-1],\"dist\":-247,\"cMask\":[\"ball\"]}],\"goals\":[{\"p0\":[-550,80],\"p1\":[-550,-80],\"team\":\"red\"},{\"p0\":[550,80],\"p1\":[550,-80],\"team\":\"blue\"}],\"discs\":[{\"cGroup\":[\"ball\",\"kick\",\"score\"]},{\"pos\":[-550,80],\"radius\":8,\"invMass\":0,\"color\":\"961515\"},{\"pos\":[-550,-80],\"radius\":8,\"invMass\":0,\"color\":\"961515\"},{\"pos\":[550,80],\"radius\":8,\"invMass\":0,\"color\":\"1E1666\"},{\"pos\":[550,-80],\"radius\":8,\"invMass\":0,\"color\":\"1E1666\"},{\"pos\":[-560,78],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-570,76],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,74],\"radius\":0.01,\"invMass\":0,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,61],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,48],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,36],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,24],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,12],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,0],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,-12],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,-24],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,-36],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,-48],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,-61],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-580,-74],\"radius\":0.01,\"invMass\":0,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-570,-76],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[-560,-77],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[564,78],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[573,76],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,74],\"radius\":0.01,\"invMass\":0,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,61],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,48],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,36],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,24],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,12],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,0],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,-12],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,-24],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,-36],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,-48],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,-61],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[580,-74],\"radius\":0.01,\"invMass\":0,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[570,-76],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]},{\"pos\":[560,-78],\"radius\":0.01,\"invMass\":1.5,\"damping\":0.96,\"color\":\"0\",\"cMask\":[\"ball\"]}],\"playerPhysics\":{\"bCoef\":1.5,\"damping\":0.9995,\"acceleration\":0.025,\"kickingAcceleration\":0.0175,\"kickingDamping\":0.9995},\"ballPhysics\":\"disc0\",\"spawnDistance\":350,\"joints\":[{\"d0\":1,\"d1\":5,\"length\":10.198039027185569},{\"d0\":5,\"d1\":6,\"length\":10.198039027185569},{\"d0\":6,\"d1\":7,\"length\":10.198039027185569},{\"d0\":7,\"d1\":8,\"length\":13},{\"d0\":8,\"d1\":9,\"length\":13},{\"d0\":9,\"d1\":10,\"length\":12},{\"d0\":10,\"d1\":11,\"length\":12},{\"d0\":11,\"d1\":12,\"length\":12},{\"d0\":12,\"d1\":13,\"length\":12},{\"d0\":13,\"d1\":14,\"length\":12},{\"d0\":14,\"d1\":15,\"length\":12},{\"d0\":15,\"d1\":16,\"length\":12},{\"d0\":16,\"d1\":17,\"length\":12},{\"d0\":17,\"d1\":18,\"length\":13},{\"d0\":18,\"d1\":19,\"length\":13},{\"d0\":19,\"d1\":20,\"length\":10.198039027185569},{\"d0\":20,\"d1\":21,\"length\":10.04987562112089},{\"d0\":21,\"d1\":2,\"length\":10.44030650891055},{\"d0\":3,\"d1\":22,\"length\":14.142135623730951},{\"d0\":22,\"d1\":23,\"length\":9.219544457292887},{\"d0\":23,\"d1\":24,\"length\":7.280109889280518},{\"d0\":24,\"d1\":25,\"length\":13},{\"d0\":25,\"d1\":26,\"length\":13},{\"d0\":26,\"d1\":27,\"length\":12},{\"d0\":27,\"d1\":28,\"length\":12},{\"d0\":28,\"d1\":29,\"length\":12},{\"d0\":29,\"d1\":30,\"length\":12},{\"d0\":30,\"d1\":31,\"length\":12},{\"d0\":31,\"d1\":32,\"length\":12},{\"d0\":32,\"d1\":33,\"length\":12},{\"d0\":33,\"d1\":34,\"length\":12},{\"d0\":34,\"d1\":35,\"length\":13},{\"d0\":35,\"d1\":36,\"length\":13},{\"d0\":36,\"d1\":37,\"length\":10.198039027185569},{\"d0\":37,\"d1\":38,\"length\":10.198039027185569},{\"d0\":38,\"d1\":4,\"length\":10.198039027185569}],\"redSpawnPoints\":[[-350,0],[-350,60],[-350,-60],[-350,120],[-350,-120],[-850,0]],\"blueSpawnPoints\":[[350,0],[350,60],[350,-60],[350,120],[350,-120],[850,0]],\"kickOffReset\":\"full\"}`;

let CONNECTION_MODE = false;
let RECAPTCHA_MODE = false;
let BLACKLIST_MODE = true;
let CLEARBANS_MODE = true;

let mainColor = 0x4CAF50;
let secondaryColor = 0xC0CA33;
let warningColor = 0xc62828;
let tipColor = 0x8bc34a;
let pmColor = 0xda00ff;

const config = {
  token: "thr1.AAAAAGPV9kJAMxzimRqcaA.TtUneaTGQwY",
  roomName: "room name",
  public: false,
  noPlayer: true,
  maxPlayers: 5,
};

const connections = {};
const AFKS = [];

const commands = {
  public: [
    {
      name: "help",
      id: 1,
      syntax: /(help|commands)/i,
      admin: false,
      display: false,
    },
    {
      name: "bb",
      id: 2,
      syntax: /(bb|leave)/i,
      admin: false,
      display: false,
    },
    {
      name: "waive",
      id: 3,
      syntax: /(waive|resign)/i,
      admin: false,
      display: false,
    },
    {
      name: "pm",
      id: 4,
      syntax: /pm #\d+ .+/i,
      admin: false,
      display: false,
    },
    {
      name: "clearbans",
      id: 5,
      syntax: /clearbans/i,
      admin: true,
      display: true,
    },
    {
      name: "afk",
      id: 6,
      syntax: /afk/i,
      admin: false,
      display: false,
    },
  ],
}

const room = HBInit(config);

room.setRequireRecaptcha(RECAPTCHA_MODE);

room.setCustomStadium(MAP)

room.onPlayerJoin = function (player) {
  check({ id: player.id, conn: player.conn });
  CLEARBANS_MODE && room.sendAnnouncement("In this demo room, banlist is emptied every 10 minutes, players who abuse permissions will be blacklisted 📌\nbecause there are no moderators in the room at the moment, so be careful!", player.id, 0x757575, "small");
  room.sendAnnouncement("Welcome " + player.name + ", Check " + commands.char + "help to show public commands", player.id, tipColor);
};

setTimeout(() => {
  CLEARBANS_MODE && room.clearBans();
}, 60000 * 10);

room.onPlayerLeave = function (player) {
  delete connections[player.id];
  removeFromAFK(player.id);
};

room.onPlayerChat = function (player, message) {
  var message = message.trim();
  if (checkCommandSyntax(message)) {
    let command = getCommandBySyntax(message);
    if (!command) return false;
    if (command.admin && !player.admin) {
      room.sendAnnouncement("You are not an admin", player.id, warningColor, null, 2);
      return false;
    }
    run(command, player, message);
    return command.display;
  }
}

room.onStadiumChange = function (newStadiumName) {
  if (newStadiumName !== "Spacebounce Official Map") {
    room.setCustomStadium(MAP);
  }
}

Object.defineProperty(connections, 'swap', {
  value: function () {
    var a = {};
    for (let key in this) {
      a[this[key]] = key;
    }
    return a;
  }
});

Object.defineProperty(commands, 'char', {
  value: "!",
  writable: true,
});

/**
 * Check if the player is blacklisted or try to join again from the same network,
 * will be kicked if one of the above two conditions is met.
 * @param { PlayerObject } player
 */

function check(player) {
  var { [player.conn]: conn } = connections.swap();
  var blacklist = [];
  if (BLACKLIST_MODE && blacklist.find(p => p.conn == player.conn)) return room.kickPlayer(player.id, 'BLACKLISTED');
  if (CONNECTION_MODE && conn) return room.kickPlayer(player.id, 'It is not allowed to join more than one player from the same network');
  connections[player.id] = player.conn;
};

/**
 * Check if the command is written in the default form.
 * @param { string } message
 * @returns `true` if the command is written in the default form, otherwise `false`.
 */

function checkCommandSyntax(message) {
  var char = commands.char;
  return message.startsWith(char) && message.length > char.length;
};

/**
 * @param { string } message
 * @returns Command properties.
 */

function getCommandBySyntax(message) {
  var message = message.slice(1);
  return [...commands.public].find(c => message.match(c.syntax)?.[0] == message);
};

function isPlayerAFK(playerID) {
  return Boolean(AFKS.find(p => p.id == playerID));
};

function removeFromAFK(playerID) {
  AFKS.forEach((p, index, array) => {
    if (p.id == playerID) {
      array.splice(index, 1);
    }
  });
};

/**
 * Once the command object is passed in, its function will be executed.
 * @param { object } command
 * @param { PlayerObject } player
 * @param { string } message
 */

function run(command, player, message) {
  switch (command.id) {
    case 1:
      const formatter = new Intl.ListFormat("en", { style: "short", type: "conjunction" });
      room.sendAnnouncement("Commands: " + formatter.format(commands.public.map((c) => commands.char + c.name)), player.id, mainColor);
    break;
    case 2:
      room.kickPlayer(player.id, "Goodbye!");
    break;
    case 3:
      room.setPlayerAdmin(player.id, false);
    break;
    case 4:
      const consignee = room.getPlayer(message.match(/[0-9]+/)[0]);
      const MESSAGE = message.split(new RegExp(commands.char + command.name + " #\\d+ ")).reduce((c , p) => c + p).trim();
      if (!consignee || consignee.id == player.id) return;
      room.sendAnnouncement("To " + consignee.name + ": " +  MESSAGE, player.id, pmColor, null, 1);
      room.sendAnnouncement("From " + player.name + ": " + MESSAGE, consignee.id, pmColor, null, 2);
    break;
    case 5:
      room.clearBans();
      room.sendAnnouncement("The Banlist has been cleared", null, secondaryColor);
    break;
    case 6:
      if (isPlayerAFK(player.id)) {
        const playerStartAFKTime = AFKS.find(p => p.id === player.id).return;
        const currentTime = new Date();
        if (!(((currentTime.getTime() - playerStartAFKTime.getTime()) / 1000) > 20)) {
          room.sendAnnouncement("You can return after " + (20 - Math.trunc((currentTime.getTime() - playerStartAFKTime.getTime()) / 1000)) +" seconds", player.id, warningColor, null, 0);
          return;
        }
        removeFromAFK(player.id);
      } else {
        AFKS.push({ name: player.name, id: player.id, return: new Date() });
        room.setPlayerAdmin(player.id, false);
        room.setPlayerTeam(player.id, 0);
      }
      room.sendAnnouncement(player.name + " " + (isPlayerAFK(player.id) ? "is now AFK" : "has returned"), null, 0xffd700);
    break;
  }
};
